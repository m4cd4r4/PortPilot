<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'">
  <title>PortPilot</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1>‚öì PortPilot</h1>
        <span class="subtitle">Localhost Port Manager</span>
      </div>
      <div class="header-right">
        <button id="btn-scan" class="btn btn-primary">
          <span class="icon">üîÑ</span> Scan Ports
        </button>
        <button id="btn-add-app" class="btn btn-secondary">
          <span class="icon">‚ûï</span> Add App
        </button>
      </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tabs">
      <button class="tab active" data-tab="ports">Active Ports</button>
      <button class="tab" data-tab="apps">My Apps</button>
      <button class="tab" data-tab="knowledge">Knowledge</button>
      <button class="tab" data-tab="settings">Settings</button>
    </nav>

    <!-- Main Content -->
    <main class="content">
      <!-- Ports Tab -->
      <section id="tab-ports" class="tab-content active">
        <div class="toolbar">
          <input type="text" id="port-filter" placeholder="Filter by port or process..." class="input-search">
          <span id="port-count" class="count-badge">0 ports</span>
        </div>
        <div id="ports-list" class="ports-grid">
          <div class="empty-state">Click "Scan Ports" to discover active ports</div>
        </div>
      </section>

      <!-- Apps Tab -->
      <section id="tab-apps" class="tab-content">
        <div class="toolbar">
          <button type="button" id="btn-refresh-apps" class="btn btn-secondary">üîÑ Refresh</button>
          <button type="button" id="btn-expand-all" class="btn btn-small btn-secondary" onclick="expandAllApps()" title="Expand all app cards">‚ñº Expand All</button>
          <button type="button" id="btn-collapse-all" class="btn btn-small btn-secondary" onclick="collapseAllApps()" title="Collapse all app cards">‚ñ∂ Collapse All</button>
          <span id="apps-count" class="count-badge">0 apps</span>
        </div>
        <div id="apps-list" class="apps-list">
          <div class="empty-state">No apps registered. Click "Add App" to get started.</div>
        </div>

        <!-- Selection Toolbar (appears when apps are selected) -->
        <div id="selection-toolbar" class="selection-toolbar hidden">
          <span id="selection-count" class="selection-count">0 selected</span>
          <div class="selection-actions">
            <button type="button" class="btn btn-small btn-secondary" onclick="selectAllApps()">Select All</button>
            <button type="button" class="btn btn-small btn-primary" onclick="favoriteSelected()">‚≠ê Favorite</button>
            <button type="button" class="btn btn-small btn-secondary" onclick="unfavoriteSelected()">‚òÜ Unfavorite</button>
            <button type="button" class="btn btn-small btn-danger" onclick="deleteSelected()">üóë Delete</button>
            <button type="button" class="btn btn-small btn-secondary" onclick="clearSelection()">Clear</button>
          </div>
        </div>
      </section>

      <!-- Knowledge Tab -->
      <section id="tab-knowledge" class="tab-content">
        <div class="knowledge-grid">
          <!-- Navigation -->
          <div class="knowledge-navigation">
            <button class="knowledge-nav-btn active" data-section="how-it-works">How It Works</button>
            <button class="knowledge-nav-btn" data-section="quick-start">Quick Start</button>
            <button class="knowledge-nav-btn" data-section="port-info">Port Cards</button>
            <button class="knowledge-nav-btn" data-section="port-actions">Port Actions</button>
            <button class="knowledge-nav-btn" data-section="shortcuts">Shortcuts</button>
            <button class="knowledge-nav-btn" data-section="tips">Tips</button>
            <button class="knowledge-nav-btn" data-section="tray">System Tray</button>
            <button class="knowledge-nav-btn" data-section="ports">Common Ports</button>
            <button class="knowledge-nav-btn" data-section="badges">App Badges</button>
            <button class="knowledge-nav-btn" data-section="ipv">IPv4/IPv6</button>
            <button class="knowledge-nav-btn" data-section="docker">Docker</button>
            <button class="knowledge-nav-btn" data-section="troubleshoot">Troubleshooting</button>
            <button class="knowledge-nav-btn" data-section="mcp">MCP/AI</button>
          </div>

          <!-- Carousel Card -->
          <div class="knowledge-carousel">
            <!-- How It Works -->
            <div class="knowledge-section active" data-section="how-it-works">
              <h3>How It Works</h3>
              <p>PortPilot scans your system for active TCP ports using native OS commands. It identifies which processes are using each port, letting you manage your development environment efficiently.</p>
              <ul class="knowledge-list">
                <li>Scans ports via <code>netstat</code> (Windows) or <code>lsof</code> (Mac/Linux)</li>
                <li>Displays process name, PID, and command line</li>
                <li>One-click kill for stuck processes</li>
                <li>Register apps with preferred ports</li>
              </ul>
            </div>

            <!-- Quick Start -->
            <div class="knowledge-section" data-section="quick-start">
              <h3>Quick Start</h3>
              <ol class="knowledge-list numbered">
                <li><strong>Scan Ports</strong> ‚Äî Click the button to discover active ports</li>
                <li><strong>Add Apps</strong> ‚Äî Register your dev projects with their start commands</li>
                <li><strong>Start/Stop</strong> ‚Äî Control apps from the My Apps tab</li>
                <li><strong>Kill Ports</strong> ‚Äî Free up stuck ports with one click</li>
              </ol>
            </div>

            <!-- Port Card Information (NEW in v1.6.1) -->
            <div class="knowledge-section" data-section="port-info">
              <h3>Port Card Information</h3>
              <p>Each port card displays comprehensive process information automatically:</p>
              <ul class="knowledge-list">
                <li><strong>:port</strong> ‚Äî Port number in cyan (e.g., :3000)</li>
                <li><strong>üè† / üåê</strong> ‚Äî Bind type indicator:
                  <ul style="margin-left: 20px; margin-top: 4px;">
                    <li>üè† = Localhost only (127.0.0.1) ‚Äî Not accessible from network</li>
                    <li>üåê = All interfaces (0.0.0.0) ‚Äî Accessible from network</li>
                  </ul>
                </li>
                <li><strong>v4 / v6</strong> ‚Äî IP protocol version badge</li>
                <li><strong>process.exe</strong> ‚Äî Process name</li>
                <li><strong>Memory</strong> ‚Äî RAM usage in MB (e.g., 142 MB)</li>
                <li><strong>Uptime</strong> ‚Äî How long process has been running (e.g., 2h 15m)</li>
                <li><strong>Connections</strong> ‚Äî Number of active TCP connections (e.g., 3 conn)</li>
                <li><strong>PID</strong> ‚Äî Process ID for advanced troubleshooting</li>
                <li><strong>CMD</strong> ‚Äî Hover to see full command path with copy button</li>
              </ul>
              <p><em>Process details are automatically fetched when you scan ports. No extra clicks needed!</em></p>
            </div>

            <!-- Port Actions (NEW in v1.6.1) -->
            <div class="knowledge-section" data-section="port-actions">
              <h3>Port Actions</h3>
              <p>Quick actions available for each port:</p>
              <div class="badge-reference">
                <div class="badge-item"><span class="badge-icon">üåê</span> <strong>Open in Browser</strong> ‚Äî Launch localhost:PORT in default browser</div>
                <div class="badge-item"><span class="badge-icon">üìÇ</span> <strong>Open Folder</strong> ‚Äî Open directory containing the process executable</div>
                <div class="badge-item"><span class="badge-icon">üìã</span> <strong>Copy</strong> ‚Äî Copy "localhost:PORT" to clipboard</div>
                <div class="badge-item"><span class="badge-icon">‚úï</span> <strong>Kill Process</strong> ‚Äî Terminate the process using this port</div>
              </div>
              <p><strong>CMD Icon:</strong> Hover over the black <code>CMD</code> badge to see the full command path in a tooltip. Click the Copy button to copy it to clipboard.</p>
            </div>

            <!-- Keyboard Shortcuts -->
            <div class="knowledge-section" data-section="shortcuts">
              <h3>Keyboard Shortcuts</h3>
              <div class="shortcut-grid">
                <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>R</kbd><span>Refresh/Scan</span></div>
                <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>N</kbd><span>Add New App</span></div>
                <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>1</kbd><span>Ports Tab</span></div>
                <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>2</kbd><span>Apps Tab</span></div>
                <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>3</kbd><span>Knowledge</span></div>
                <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>4</kbd><span>Settings</span></div>
              </div>
            </div>

            <!-- Tips & Tricks -->
            <div class="knowledge-section" data-section="tips">
              <h3>Tips & Tricks</h3>
              <ul class="knowledge-list">
                <li>Use <strong>fallback port ranges</strong> when your preferred port is busy</li>
                <li>Click the <strong>copy button</strong> to get <code>localhost:PORT</code> to clipboard</li>
                <li>Minimize to <strong>system tray</strong> ‚Äî click the tray icon to restore</li>
                <li>Right-click the <strong>tray icon</strong> for quick access to "Stop All Apps"</li>
                <li>Set <strong>auto-start</strong> on apps you always need running</li>
                <li><strong>Export config</strong> to back up your app registrations</li>
              </ul>
            </div>

            <!-- System Tray -->
            <div class="knowledge-section" data-section="tray">
              <h3>System Tray</h3>
              <p>PortPilot lives in your system tray for quick access:</p>
              <ul class="knowledge-list">
                <li><strong>Left-click</strong> the tray icon to show/hide the window</li>
                <li><strong>Right-click</strong> for the menu:
                  <ul style="margin-left: 20px; margin-top: 5px;">
                    <li>Show PortPilot ‚Äî Restore the window</li>
                    <li>Scan Ports ‚Äî Run a port scan</li>
                    <li><strong>Stop All Apps</strong> ‚Äî Stop all PortPilot-managed apps without quitting</li>
                    <li>Quit ‚Äî Exit PortPilot</li>
                  </ul>
                </li>
                <li>Configure <strong>window behavior</strong> in Settings:
                  <ul style="margin-left: 20px; margin-top: 5px;">
                    <li>Minimize to tray on close (default: on)</li>
                    <li>Stop running apps when quitting (default: on)</li>
                  </ul>
                </li>
              </ul>
              <p><em>Note: Only apps started by PortPilot are affected. External processes are never touched.</em></p>
            </div>

            <!-- Common Ports -->
            <div class="knowledge-section" data-section="ports">
              <h3>Common Dev Ports</h3>
              <div class="port-reference">
                <div class="port-item"><span class="port-num">3000</span> React, Next.js, Express</div>
                <div class="port-item"><span class="port-num">4200</span> Angular CLI</div>
                <div class="port-item"><span class="port-num">5173</span> Vite</div>
                <div class="port-item"><span class="port-num">5432</span> PostgreSQL</div>
                <div class="port-item"><span class="port-num">6379</span> Redis</div>
                <div class="port-item"><span class="port-num">8000</span> Django, FastAPI</div>
                <div class="port-item"><span class="port-num">8080</span> Tomcat, Live Server</div>
                <div class="port-item"><span class="port-num">27017</span> MongoDB</div>
              </div>
            </div>

            <!-- App Badges -->
            <div class="knowledge-section" data-section="badges">
              <h3>App Badges</h3>
              <p>PortPilot automatically detects app requirements and shows badges:</p>
              <div class="badge-reference">
                <div class="badge-item"><span class="badge-icon">üê≥</span> <strong>Docker</strong> ‚Äî App uses Docker/Compose (click to start Docker Desktop)</div>
                <div class="badge-item"><span class="badge-icon">üì¶</span> <strong>Node.js</strong> ‚Äî Uses npm, npx, pnpm, yarn, or bun</div>
                <div class="badge-item"><span class="badge-icon">üêç</span> <strong>Python</strong> ‚Äî Uses python, uvicorn, flask, or django</div>
                <div class="badge-item"><span class="badge-icon">üóÑÔ∏è</span> <strong>Database</strong> ‚Äî Uses postgres, mysql, redis, or mongo</div>
                <div class="badge-item"><span class="badge-icon">‚ö°</span> <strong>Auto-start</strong> ‚Äî App starts automatically on launch</div>
                <div class="badge-item"><span class="badge-icon">üåê</span> <strong>Remote</strong> ‚Äî App runs on a remote server/VPS</div>
              </div>
            </div>

            <!-- IPv4/IPv6 -->
            <div class="knowledge-section" data-section="ipv">
              <h3>IPv4 vs IPv6</h3>
              <p>When apps are running, PortPilot shows which IP protocol they're bound to:</p>
              <ul class="knowledge-list">
                <li><strong>v4</strong> ‚Äî App is bound to IPv4 (e.g., <code>0.0.0.0:3000</code> or <code>127.0.0.1:3000</code>)</li>
                <li><strong>v6</strong> ‚Äî App is bound to IPv6 (e.g., <code>[::]:3000</code> or <code>[::1]:3000</code>)</li>
              </ul>
              <p>This matters because browsers may prefer IPv6. PortPilot opens the correct URL based on the binding.</p>
              <p><strong>New in v1.6.1:</strong> Port cards now show v4/v6 badges inline for instant visibility.</p>
            </div>

            <!-- Docker Integration -->
            <div class="knowledge-section" data-section="docker">
              <h3>Docker Integration</h3>
              <p>PortPilot integrates with Docker Desktop:</p>
              <ul class="knowledge-list">
                <li><strong>Yellow pulsing üê≥</strong> ‚Äî Docker Desktop is not running</li>
                <li><strong>Green üê≥</strong> ‚Äî Docker Desktop is running and ready</li>
                <li><strong>Click the badge</strong> ‚Äî Starts Docker Desktop automatically</li>
                <li>PortPilot polls until Docker is ready, then updates the display</li>
              </ul>
              <p>Docker apps will fail to start if Docker Desktop isn't running first.</p>
            </div>

            <!-- Troubleshooting -->
            <div class="knowledge-section" data-section="troubleshoot">
              <h3>Troubleshooting</h3>
              <div class="faq-list">
                <details class="faq-item">
                  <summary>Port won't kill?</summary>
                  <p>Some system processes require admin privileges. Try running PortPilot as Administrator.</p>
                </details>
                <details class="faq-item">
                  <summary>App won't start?</summary>
                  <p>Check the working directory path and ensure the command is correct. View app logs for errors.</p>
                </details>
                <details class="faq-item">
                  <summary>Scan shows nothing?</summary>
                  <p>No apps are using TCP ports. This is normal if nothing is running locally.</p>
                </details>
                <details class="faq-item">
                  <summary>Docker app fails?</summary>
                  <p>Make sure Docker Desktop is running first. Click the yellow üê≥ badge to start it.</p>
                </details>
                <details class="faq-item">
                  <summary>Wrong app opens in browser?</summary>
                  <p>Multiple apps may share a port on IPv4 vs IPv6. Check the v4/v6 indicator.</p>
                </details>
                <details class="faq-item">
                  <summary>Why does a port show "N/A" for memory or uptime?</summary>
                  <p>PortPilot couldn't retrieve process details (permission denied or process ended). The port scan shows what's listening, but extended info requires process access. Try running PortPilot as Administrator for system processes.</p>
                </details>
                <details class="faq-item">
                  <summary>What does üè† vs üåê mean on port cards?</summary>
                  <p>üè† means the service only listens on localhost (127.0.0.1) and isn't accessible from other computers. üåê means it's bound to all network interfaces (0.0.0.0) and can be accessed from other devices on your network.</p>
                </details>
              </div>
            </div>

            <!-- MCP Integration -->
            <div class="knowledge-section" data-section="mcp">
              <h3>AI Agent Integration (MCP)</h3>
              <p>Control PortPilot with natural language via any MCP-compatible AI assistant:</p>
              <div class="mcp-commands">
                <div class="mcp-command">"List all my PortPilot apps"</div>
                <div class="mcp-command">"Start the azure-practice-exam-platform app"</div>
                <div class="mcp-command">"What's running on port 3001?"</div>
                <div class="mcp-command">"Kill whatever is running on port 3000"</div>
                <div class="mcp-command">"Favorite the AzurePrep app"</div>
              </div>
              <p class="mcp-compat"><strong>Works with:</strong> Claude Code, Claude Desktop, Cursor, Windsurf, Cline</p>
              <a href="#" class="mcp-setup-link" onclick="openExternal('https://github.com/m4cd4r4/PortPilot/tree/master/mcp-server')">Setup Guide ‚Üí</a>
            </div>
          </div>
        </div>

        <!-- Footer Links -->
        <div class="knowledge-footer">
          <a href="#" class="footer-link" onclick="openExternal('https://github.com/m4cd4r4/PortPilot#readme')">
            <span class="link-icon">üìñ</span>
            <span>Documentation</span>
          </a>
          <a href="#" class="footer-link" onclick="openExternal('https://github.com/m4cd4r4/PortPilot/discussions')">
            <span class="link-icon">üí¨</span>
            <span>Community</span>
          </a>
          <a href="#" class="footer-link" onclick="openExternal('https://github.com/m4cd4r4/PortPilot/issues/new')">
            <span class="link-icon">üêõ</span>
            <span>Report Issue</span>
          </a>
          <a href="#" class="footer-link" onclick="openExternal('https://github.com/m4cd4r4/PortPilot')">
            <span class="link-icon">‚≠ê</span>
            <span>Star on GitHub</span>
          </a>
        </div>
      </section>

      <!-- Settings Tab -->
      <section id="tab-settings" class="tab-content">
        <div class="settings-section">
          <h3>Theme</h3>
          <div class="setting-row">
            <span>Select Theme</span>
            <div class="theme-selector" id="theme-selector">
              <button class="theme-btn active" data-theme="tokyonight">TokyoNight</button>
              <button class="theme-btn" data-theme="brutalist-dark">Brutalist Dark</button>
              <button class="theme-btn" data-theme="nord">Nord</button>
              <button class="theme-btn" data-theme="dracula">Dracula</button>
              <button class="theme-btn" data-theme="solarized-light">Solarized</button>
            </div>
          </div>
        </div>
        <div class="settings-section">
          <h3>Preferences</h3>
          <label class="setting-row">
            <span>Auto-scan on startup</span>
            <input type="checkbox" id="setting-autoscan" checked>
          </label>
          <label class="setting-row">
            <span>Scan interval (seconds)</span>
            <input type="number" id="setting-interval" value="5" min="1" max="60" class="input-small">
          </label>
          <label class="setting-row">
            <span>Open DevTools on startup (dev mode only)</span>
            <input type="checkbox" id="setting-devtools">
          </label>
        </div>
        <div class="settings-section">
          <h3>Window Behavior</h3>
          <label class="setting-row">
            <span>Minimize to tray on close</span>
            <input type="checkbox" id="setting-close-to-tray" checked>
          </label>
          <label class="setting-row">
            <span>Stop running apps when quitting</span>
            <input type="checkbox" id="setting-stop-apps-on-quit" checked>
          </label>
          <p class="setting-description">
            When enabled, PortPilot will automatically stop all apps it started when you quit the application. External processes will not be affected.
          </p>
        </div>
        <div class="settings-section">
          <h3>Data</h3>
          <div class="button-row">
            <button id="btn-export" class="btn btn-secondary">Export Config</button>
            <button id="btn-import" class="btn btn-secondary">Import Config</button>
          </div>
        </div>

        <!-- Project Discovery -->
        <div class="settings-section">
          <h3>Project Discovery</h3>
          <label class="setting-row">
            <span>Auto-scan on startup</span>
            <input type="checkbox" id="setting-discovery-autoscan">
          </label>
          <div class="setting-row">
            <span>Max scan depth</span>
            <input type="number" id="setting-discovery-depth" value="2" min="1" max="5" class="input-small" title="Maximum directory depth to scan">
          </div>
          <div class="form-group">
            <label>Scan Paths</label>
            <div id="scan-paths-list" class="scan-paths-list">
              <!-- Dynamically populated -->
            </div>
            <button id="btn-add-scan-path" class="btn btn-secondary">Add Path</button>
          </div>
          <button id="btn-discover-projects" class="btn btn-primary">
            <span class="icon">üîç</span> Discover Projects
          </button>
        </div>
      </section>
    </main>

    <!-- App Modal -->
    <div id="modal-app" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title">Add App</h2>
          <button class="btn-close" id="modal-close">‚úï</button>
        </div>
        <form id="app-form">
          <input type="hidden" id="app-id">
          <div class="form-group">
            <label for="app-name">App Name</label>
            <input type="text" id="app-name" required placeholder="e.g., AzurePrep Frontend">
          </div>
          <div class="form-group">
            <label for="app-command">Command</label>
            <input type="text" id="app-command" required placeholder="e.g., npm run dev">
          </div>
          <div class="form-group">
            <label for="app-cwd">Working Directory</label>
            <input type="text" id="app-cwd" placeholder="e.g., C:\Projects\myapp">
            <button type="button" class="btn btn-secondary btn-full-width btn-auto-detect" id="btn-auto-detect">
              üîç Browse & Auto-detect Project
            </button>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="app-port">Preferred Port</label>
              <div class="input-with-button">
                <input type="number" id="app-port" placeholder="e.g., 3000">
                <button type="button" class="btn btn-small" id="btn-find-port" title="Find next available port">Find Free</button>
              </div>
            </div>
            <div class="form-group">
              <label for="app-fallback">Fallback Range</label>
              <input type="text" id="app-fallback" placeholder="e.g., 3001-3010">
            </div>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="app-autostart">
              Auto-start on launch
            </label>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="btn-cancel">Cancel</button>
            <button type="submit" class="btn btn-primary">Save App</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Discovered Projects Modal -->
    <div id="modal-discoveries" class="modal hidden">
      <div class="modal-content modal-wide">
        <div class="modal-header">
          <h2>Discovered Projects</h2>
          <span id="discoveries-count" class="count-badge">0 found</span>
          <button type="button" class="btn-close" id="discoveries-close">‚úï</button>
        </div>
        <div class="discoveries-list" id="discoveries-list">
          <!-- Dynamically populated -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="btn-discoveries-cancel">Close</button>
          <button type="button" class="btn btn-secondary" id="btn-select-all-projects">Select All</button>
          <button type="button" class="btn btn-primary hidden" id="btn-add-selected-projects">Add Selected</button>
          <button type="button" class="btn btn-primary" id="btn-add-all-discoveries">Add All</button>
        </div>
      </div>
    </div>

    <!-- Delete App Confirmation Modal -->
    <div id="modal-delete-confirm" class="modal hidden">
      <div class="modal-content modal-danger">
        <div class="modal-header">
          <h2>‚ö†Ô∏è Delete App</h2>
          <button type="button" class="btn-close" id="delete-confirm-close">‚úï</button>
        </div>
        <div class="modal-body">
          <p class="warning-text">
            Delete "<strong id="delete-app-name"></strong>"?
          </p>
          <p class="danger-text">
            ‚ö†Ô∏è This action cannot be undone.
          </p>
          <!-- Discrete Delete All option -->
          <div class="delete-all-option">
            <button type="button" class="btn-link-danger" id="btn-delete-all-instead">
              Delete all <span id="total-apps-count">0</span> apps instead
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="btn-delete-cancel">Cancel</button>
          <button type="button" class="btn btn-danger" id="btn-delete-confirm">Delete This App</button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>
  </div>

  <script src="renderer.js"></script>
</body>
</html>
